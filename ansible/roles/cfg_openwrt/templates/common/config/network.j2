#jinja2: trim_blocks: "true", lstrip_blocks: "true"

config interface 'loopback'
	option ifname 'lo'
	option proto 'static'
	option ipaddr '127.0.0.1'
	option netmask '255.0.0.0'
	option dns '{{ dns_servers | join(' ') }}'

{% if switch_ports|default(0) > 0 %}
config switch
	option name 'switch0'
	option reset '1'
	option enable_vlan '1'

  {% for network in networks %}
    {% set portmapping = [] %}
    {% for port in range(switch_ports)|list|difference(switch_ignore_ports) %}
      {% set tagged = not network.get('untagged') or port == switch_int_port %}
      {{ portmapping.append(port|string + "t" if tagged else "") }}
    {%- endfor %}

config switch_vlan
	option device 'switch0'
	option vlan '{{ network['vid'] }}'
	option ports '{{ portmapping|join(' ') }}'
  {% endfor %}
{% endif %}

{% for network in networks | selectattr('assignments', 'contains', inventory_hostname) %}
config interface '{{ network['name'] if 'name' in network else network['role'] }}'
	option proto 'static'
	option ipaddr '{{ network['prefix'] | ipaddr(network['assignments'][inventory_hostname]) }}'
	option ifname '{{ int_port }}.{{ network['vid'] }}'
{% endfor %}
